# 26 May 2010 --rb

##############################################################
# check user and set OS-specific paths
if (Sys.info()["user"]=="rb21")
{	 setwd("/Users/rb21/Documents/Projekte/GameSec2010/tex/R")
	 Sys.setenv(PATH=paste(Sys.getenv("PATH"),"/usr/texbin",sep=":"))
	 require(tikzDevice)
	 }
##############################################################

tikznode <- function(p,label)
{
	dx <- grconvertX(p$x,,'device')
    dy <- grconvertY(p$y,,'device')
    tikzAnnotate(paste('\\draw (',dx,',',dy,') node (',label,') {};',sep=""))
}

# ------------------------------------------------------------------

# value of terminal nodes

T1 <- function(t,k,a=1000,r=.05,n=20)
# secure state reached
{
	(n-t+1)*(r*a-k)
	}
	
T2 <- function(t,a=1000,r=.05,z=.025,n=20)
# indefensible state (giving up, disinvest)
{
	(n-t+1)*(r-z)*a
	}
	
# ------------------------------------------------------------------

# pdf of number relevant threats after initial defense of k

dK <- function(k=0,n=25,x1=15,dx=1,sigma=0,a=1000,z=.025,eps=10^-8)
# returns vector of probability for exactly 0..n relevant threats
{
	P <- 1-pnorm(x1+0:(n-1)*dx-a*z,mean=eps,sd=sigma/dx)
	if (k>0) P <- tail(P,-k)
	v <- sum(P*(1-P))
	m <- sum(P)
	
	K <- 1:n
	res <- pnorm(K+.5,m,sqrt(v))-pnorm(K-.5,m,sqrt(v))
	res <- c(1-sum(res),res)
	names(res) <- 0:n
	res
	}

#test
barplot(dK())
barplot(dK(4,sigma=3))

# ------------------------------------------------------------------

# profit of a run with fixed ...
# - number of remaining relevant threats K [0..n]
# - number of initial defenses k [0..n]
# - starting round of pentest m [1..n, 0 for no pentest]

G1 <- function(K,k,m,n=25,p=1,a=1000,z=.025,r=.05,c=.5)
{
	# calc number of pentests for m, K  (not sure if this holds for p<1)
	M <- (m!=0)*max(0,ceiling((K-(m-1))/(1+p)))
	
	s1 <- (K!=0)*sum(a*(r-z)-(k+1:K-1)) 
	s2 <- (M!=0)*sum(a*z-c-(K-2*(1:M)-m+3))  ## CHECK THIS
	s3 <- (n-K)*sum(a*r-k-K)
	
	s1 + p*s2 + s3
	}


# ------------------------------------------------------------------

# expected profit of a run with fixed ...
# - number of initial defenses k [0..n]
# - starting round of pentest m [1..n, 0 for no pentest]

G2 <- function(k,m,n=25,p=1,a=1000,z=.025,r=.05,c=.5,x1=15,dx=1,sigma=0)
{
	P <- dK(k=k,n=n,x1=x1,dx=dx,sigma=sigma,a=a,z=z)
	G <- sapply(as.numeric(names(P)),G1,k=k,m=m,n=n,p=p,a=a,z=z,r=r,c=c)
	sum(P*G)
	}
	
# ------------------------------------------------------------------

# k-by-m decision matrix, search supremum tuple for best strategy and attach as attributes

decision.matrix <- function(n=25,...)
{
	M <- sapply(0:n,function(m)	sapply(0:n, G2, m=m, n=n, ...))
	colnames(M) <- paste("m=",0:n,sep="")
	rownames(M) <- paste("k=",0:n,sep="")
	attr(M,"best.k") <- which.max(M)%%NROW(M)-1
	attr(M,"best.m") <- which.max(M)%/%NROW(M)
	attr(M,"best.k.m0") <- as.numeric(which.max(M[,1])-1) # best choice of k w/o pentest
	M
	}

# example for late pentest
# persp(decision.matrix(sigma=10,c=23),theta=45,phi=40)


myplot <- function(n=25,theta=10,phi=60,shade=.2,tikz=FALSE,...)
{
	M <- decision.matrix(n=n,...)
	pmat <- persp(M,theta=theta,phi=phi,shade=shade,zlab="profit",xlab="initial defense $\\dnull$",ylab="$m_1$")
	if (tikz)
	{	tikznode(trans3d((which.max(M)%%NROW(M)-1)/(NROW(M)-1),
				 (which.max(M)%/%NROW(M))/(NROW(M)-1),max(M),pmat),"optpt")
		tikznode(trans3d((which.max(M[,1])-1)/(NROW(M)-1),0,max(M[,1]),pmat),"optnpt")
		}
	else
	{
		mtext(paste("optimal k w/ pentest:",attr(M,"best.k"),
				"optimal k w/o pentest:",attr(M,"best.k.m0")),1)
	}
		points(trans3d(attr(M,"best.k")/(NROW(M)-1),
				   	   attr(M,"best.m")/(NROW(M)-1),max(M),pmat),col="white",pch=16,cex=1.5)
		points(trans3d(attr(M,"best.k.m0")/(NROW(M)-1),0,max(M[,1]),pmat),col="white",pch=16,cex=1.5)
		points(trans3d(attr(M,"best.k")/(NROW(M)-1),
				   	   attr(M,"best.m")/(NROW(M)-1),max(M),pmat),col="black",pch=1,cex=1.5)
		points(trans3d(attr(M,"best.k.m0")/(NROW(M)-1),0,max(M[,1]),pmat),col="black",pch=1,cex=1.5)
}

# myplot(sigma=16,c=20,p=0.1,theta=10,phi=60)


# ---- this line produces the figure for the paper
tikz("../figs/perspplot.tex",6,6,bareBones=TRUE)
myplot(sigma=4,c=.5,theta=25,phi=50,tikz=TRUE)
dev.off()


# ------------------------------------------------------------------

# ROPT analysis

ropt <- function(n=25,a=1000,z=.025,p=1,r=.5,c=.5,...)
{
	M <- decision.matrix(n=n,a=a,z=z,p=p,r=r,c=c,...)
	
	dK.pt <- dK(k=attr(M,"best.k"),n=n,a=a,z=z,...)
	dK.npt <- dK(k=attr(M,"best.k.m0"),n=n,a=a,z=z,...)
	
	# calculate number of attacks for p=1
	
	m <- attr(M,"best.m"); 
	if (m==0) 
		n.att <- 0:n
	else
		n.att <- (0:n<m)*0:n + (0:n>=m)*ceiling((0:n-m)/2+m-1)
		
	# calculate attack intensity per round
	
	A.npt <- 100*sum(0:n * dK.npt)/n
	A.pt  <- (1-p)*A.npt + p*(100*sum(n.att * dK.pt)/n)
		
	# calculate max return
	
	R <- n*a*r
	
	# calculate losses
	
	L0 		<- n*a*z
	L.npt	<- sum(dK.npt * 0:n * a*z)
	L.pt	<- p*sum(dK.pt * n.att * a*z) + (1-p)*L.npt
	
	# calculate security investment as residual using accounting identities
	
	S.npt	<- R - max(M[,1]) - L.npt
	S.pt	<- R - max(M) - L.pt
	
	# calculate indicators
	
	rosi.npt <- (L0 - L.npt - S.npt) / S.npt
	rosi.pt  <- (L0 - L.pt - S.pt) / S.pt
	
	list(ropt=rosi.pt-rosi.npt,rosi.pt=rosi.pt,rosi.npt=rosi.npt,
			A.pt=A.pt,A.npt=A.npt,
			L.pt=L.pt,L.npt=L.npt,
			S.pt=S.pt,S.npt=S.npt)
	}
	
# produce ROPT sigma-chart
# ---- this part produces the figure for the paper

SIGMA <- c(0,1,2,5,10,15,20,25,30,35,40)
COST  <- c(.5,5,10)
d <- sapply(SIGMA,function(s) sapply(COST,function(c,sigma) ropt(sigma=sigma,c=c)$ropt,sigma=s))	
tikz("../figs/ropt-sigma.tex",6,4,bareBones=TRUE)
plot(NA,NA,ylim=100*range(c(range(d),.5,-.05)),xlim=range(SIGMA),bty="n",
	yaxs="i",las=1,xlab="uncertainty $\\sigma$",ylab="ROPT {\\small[\\%-pts.\\ of security investment]}")
rect(-5,-5,50,0,col="lightgrey",border=NA)
box()
lines(SIGMA,100*d[1,],type="b",pch=1)	 
lines(SIGMA,100*d[2,],type="b",pch=2)	 
lines(SIGMA,100*d[3,],type="b",pch=8)	 
legend("topright",bty="n",pch=c(1,2,8),leg=paste("$c =",COST,"$"),inset=.01)
dev.off()

# ------------------------------------------------------------------

